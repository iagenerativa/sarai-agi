
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://iagenerativa.github.io/sarai-agi/INTEGRATION_ARCHITECTURE/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>SARAi AGI - Arquitectura de IntegraciÃ³n v3.6.0 - SARAi_AGI Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sarai-agi-arquitectura-de-integracion-v360" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href=".." title="SARAi_AGI Docs" class="md-header__button md-logo" aria-label="SARAi_AGI Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SARAi_AGI Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SARAi AGI - Arquitectura de IntegraciÃ³n v3.6.0
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="BÃºsqueda" placeholder="BÃºsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando bÃºsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/iagenerativa/sarai-agi" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    iagenerativa/sarai-agi
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="NavegaciÃ³n" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="SARAi_AGI Docs" class="md-nav__button md-logo" aria-label="SARAi_AGI Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    SARAi_AGI Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/iagenerativa/sarai-agi" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    iagenerativa/sarai-agi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inicio
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE_OVERVIEW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Arquitectura
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../MIGRATION_PLAN_v3_5_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plan de MigraciÃ³n
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROADMAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Roadmap
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vision-general" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ¯ VisiÃ³n General
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arquitectura-del-sistema-integrado" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ—ï¸ Arquitectura del Sistema Integrado
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ—ï¸ Arquitectura del Sistema Integrado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diagrama-de-flujo-completo" class="md-nav__link">
    <span class="md-ellipsis">
      Diagrama de Flujo Completo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#componentes-integrados" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“¦ Componentes Integrados
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ“¦ Componentes Integrados">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-trm-classifier-classifiertrmpy" class="md-nav__link">
    <span class="md-ellipsis">
      1. TRM Classifier (classifier/trm.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-mcp-core-mcpcorepy" class="md-nav__link">
    <span class="md-ellipsis">
      2. MCP Core (mcp/core.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-emotional-context-engine-emotioncontext_enginepy" class="md-nav__link">
    <span class="md-ellipsis">
      3. Emotional Context Engine (emotion/context_engine.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cascade-router-cascadeconfidence_routerpy" class="md-nav__link">
    <span class="md-ellipsis">
      4. Cascade Router (cascade/confidence_router.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-model-pool-modelpoolpy" class="md-nav__link">
    <span class="md-ellipsis">
      5. Model Pool (model/pool.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-rag-agent-agentsragpy" class="md-nav__link">
    <span class="md-ellipsis">
      6. RAG Agent (agents/rag.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flujo-de-ejecucion-detallado" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”„ Flujo de EjecuciÃ³n Detallado
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ”„ Flujo de EjecuciÃ³n Detallado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejemplo-1-query-tecnica" class="md-nav__link">
    <span class="md-ellipsis">
      Ejemplo 1: Query TÃ©cnica
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-2-query-emocional" class="md-nav__link">
    <span class="md-ellipsis">
      Ejemplo 2: Query Emocional
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-3-query-web" class="md-nav__link">
    <span class="md-ellipsis">
      Ejemplo 3: Query Web
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integracion-de-componentes" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ§© IntegraciÃ³n de Componentes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ§© IntegraciÃ³n de Componentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#factory-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Factory Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependency-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Dependency Injection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graceful-degradation" class="md-nav__link">
    <span class="md-ellipsis">
      Graceful Degradation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metricas-del-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“Š MÃ©tricas del Pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ“Š MÃ©tricas del Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pipeline-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Pipeline Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-targets-v360" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Targets (v3.6.0)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-de-integracion" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ§ª Testing de IntegraciÃ³n
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ§ª Testing de IntegraciÃ³n">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-suite-completo" class="md-nav__link">
    <span class="md-ellipsis">
      Test Suite Completo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uso-desde-cli" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸš€ Uso desde CLI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸš€ Uso desde CLI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalacion" class="md-nav__link">
    <span class="md-ellipsis">
      InstalaciÃ³n
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-integrada" class="md-nav__link">
    <span class="md-ellipsis">
      CLI Integrada
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“š Referencias
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ“š Referencias">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documentacion-de-componentes" class="md-nav__link">
    <span class="md-ellipsis">
      DocumentaciÃ³n de Componentes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    <span class="md-ellipsis">
      Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentacion-adicional" class="md-nav__link">
    <span class="md-ellipsis">
      DocumentaciÃ³n Adicional
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roadmap-de-integracion" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ¯ Roadmap de IntegraciÃ³n
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ¯ Roadmap de IntegraciÃ³n">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#completado-v360" class="md-nav__link">
    <span class="md-ellipsis">
      âœ… Completado (v3.6.0)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#en-progreso-v370" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”„ En Progreso (v3.7.0)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pendiente-v40" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“‹ Pendiente (v4.0+)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changelog" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“ Changelog
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ“ Changelog">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#v360-2025-11-04" class="md-nav__link">
    <span class="md-ellipsis">
      v3.6.0 (2025-11-04)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="sarai-agi-arquitectura-de-integracion-v360">SARAi AGI - Arquitectura de IntegraciÃ³n v3.6.0<a class="headerlink" href="#sarai-agi-arquitectura-de-integracion-v360" title="Permanent link">&para;</a></h1>
<h2 id="vision-general">ğŸ¯ VisiÃ³n General<a class="headerlink" href="#vision-general" title="Permanent link">&para;</a></h2>
<p>Este documento describe la <strong>arquitectura integrada</strong> de SARAi v3.6.0, donde todos los componentes modulares se conectan en un sistema cohesivo end-to-end.</p>
<p><strong>Estado:</strong> âœ… PRODUCCIÃ“N (v3.6.0)
<strong>Ãšltima actualizaciÃ³n:</strong> 2025-11-04</p>
<hr />
<h2 id="arquitectura-del-sistema-integrado">ğŸ—ï¸ Arquitectura del Sistema Integrado<a class="headerlink" href="#arquitectura-del-sistema-integrado" title="Permanent link">&para;</a></h2>
<h3 id="diagrama-de-flujo-completo">Diagrama de Flujo Completo<a class="headerlink" href="#diagrama-de-flujo-completo" title="Permanent link">&para;</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INPUT STAGE                                   â”‚
â”‚  â€¢ Input parsing y validaciÃ³n                                       â”‚
â”‚  â€¢ State initialization                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CLASSIFICATION STAGE (TRM Classifier)                  â”‚
â”‚  Callable: trm_classifier(state) â†’ scores                           â”‚
â”‚                                                                      â”‚
â”‚  Output:                                                             â”‚
â”‚    - hard: float (0.0-1.0)    # Complejidad tÃ©cnica                 â”‚
â”‚    - soft: float (0.0-1.0)    # Complejidad emocional               â”‚
â”‚    - web_query: float (0.0-1.0)  # Necesidad de bÃºsqueda web        â”‚
â”‚                                                                      â”‚
â”‚  ImplementaciÃ³n:                                                     â”‚
â”‚    - PRIMARY: TRMClassifier (torch, trained model)                  â”‚
â”‚    - FALLBACK: Rule-based classifier (keywords)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WEIGHTING STAGE (MCP Core)                           â”‚
â”‚  Callable: mcp_weighter(state) â†’ weights                            â”‚
â”‚                                                                      â”‚
â”‚  Input: hard, soft scores                                           â”‚
â”‚  Output:                                                             â”‚
â”‚    - alpha: float (0.0-1.0)   # Weight para expert agent            â”‚
â”‚    - beta: float (0.0-1.0)    # Weight para empathy agent           â”‚
â”‚                                                                      â”‚
â”‚  ImplementaciÃ³n:                                                     â”‚
â”‚    - PRIMARY: MCPCore (rules-based o learned mode)                  â”‚
â”‚    - FALLBACK: Direct mapping (alpha=hard, beta=soft)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                   â”‚ (Parallel execution if enabled)
                 â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  EMOTION DETECTION   â”‚  â”‚  MODEL PREFETCH      â”‚
    â”‚  (Optional)          â”‚  â”‚  (Optional)          â”‚
    â”‚                      â”‚  â”‚                      â”‚
    â”‚  Input: state        â”‚  â”‚  Input: state        â”‚
    â”‚  Output: emotion{}   â”‚  â”‚  Output: model_name  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ROUTING STAGE (Cascade Router)                          â”‚
â”‚  Callable: router(state) â†’ agent_key                                â”‚
â”‚                                                                      â”‚
â”‚  Decision Tree (7 priorities):                                      â”‚
â”‚    1. Vision     â†’ &quot;vision&quot;     (imagen/OCR/grÃ¡ficos)               â”‚
â”‚    2. Code       â†’ &quot;code&quot;       (programming skill)                 â”‚
â”‚    3. RAG        â†’ &quot;rag&quot;        (web_query â‰¥ 0.7)                   â”‚
â”‚    4. Omni-Loop  â†’ &quot;omni&quot;       (imagen + texto &gt;20 chars)          â”‚
â”‚    5. Audio      â†’ &quot;audio&quot;      (input_type == &quot;audio&quot;)             â”‚
â”‚    6. Expert     â†’ &quot;expert&quot;     (alpha â‰¥ 0.7)                       â”‚
â”‚    7. Empathy    â†’ &quot;empathy&quot;    (beta â‰¥ 0.7)                        â”‚
â”‚    8. Balanced   â†’ &quot;balanced&quot;   (fallback default)                  â”‚
â”‚                                                                      â”‚
â”‚  ImplementaciÃ³n: ConfidenceRouter + custom logic                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EXECUTION STAGE (Model Pool + Generators)                  â”‚
â”‚  Callable: response_generator(state, agent_key) â†’ response          â”‚
â”‚                                                                      â”‚
â”‚  Agent-specific execution:                                          â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€ RAG Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  1. Safe Mode check                                        â”‚     â”‚
â”‚  â”‚  2. Web search (SearXNG + cache)                           â”‚     â”‚
â”‚  â”‚  3. Audit PRE (SHA-256)                                    â”‚     â”‚
â”‚  â”‚  4. Synthesis prompt                                       â”‚     â”‚
â”‚  â”‚  5. LLM generation (expert model)                          â”‚     â”‚
â”‚  â”‚  6. Audit POST (HMAC)                                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€ Expert Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  CASCADE 3-Tier Routing:                                   â”‚     â”‚
â”‚  â”‚    - Tier 1: LFM2-1.2B     (confidence â‰¥0.6) ~1.2s        â”‚     â”‚
â”‚  â”‚    - Tier 2: MiniCPM-4.1   (0.3-0.6)        ~4s           â”‚     â”‚
â”‚  â”‚    - Tier 3: Qwen-3-8B     (&lt;0.3)           ~15s          â”‚     â”‚
â”‚  â”‚                                                            â”‚     â”‚
â”‚  â”‚  Features:                                                 â”‚     â”‚
â”‚  â”‚    - Dynamic quantization (IQ3_XXS/Q4_K_M/Q5_K_M)          â”‚     â”‚
â”‚  â”‚    - Context JIT (adaptive n_ctx)                          â”‚     â”‚
â”‚  â”‚    - LRU/TTL cache (hot: 5min, warm: 45s, cold: 15s)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€ Empathy Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  - Model: LFM2-1.2B (tiny)                                 â”‚     â”‚
â”‚  â”‚  - Mode: EmpatÃ­a                                           â”‚     â”‚
â”‚  â”‚  - Features: Emotional context awareness                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€ Balanced Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  - Model: expert_short (LFM2 + escalation)                 â”‚     â”‚
â”‚  â”‚  - Mode: Balanceado entre hard/soft                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POST-PROCESSING STAGE (Fluidity - TODO)                 â”‚
â”‚  â€¢ Tone smoothing                                                   â”‚
â”‚  â€¢ Response enhancement                                             â”‚
â”‚  â€¢ Cultural adaptation                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OUTPUT STAGE                                  â”‚
â”‚  State completo con:                                                â”‚
â”‚    - response: str                                                  â”‚
â”‚    - metadata: dict                                                 â”‚
â”‚      - agent: str                                                   â”‚
â”‚      - emotion: dict                                                â”‚
â”‚      - pipeline_metrics: dict                                       â”‚
â”‚    - scores: hard, soft, web_query, alpha, beta                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="componentes-integrados">ğŸ“¦ Componentes Integrados<a class="headerlink" href="#componentes-integrados" title="Permanent link">&para;</a></h2>
<h3 id="1-trm-classifier-classifiertrmpy">1. TRM Classifier (<code>classifier/trm.py</code>)<a class="headerlink" href="#1-trm-classifier-classifiertrmpy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> Clasificar intenciones del input en 3 scores independientes.</p>
<p><strong>Callable Signature:</strong></p>
<pre><code class="language-python">ClassifierCallable = Callable[[Dict[str, Any]], Dict[str, float]]

# Input:
state = {&quot;input&quot;: &quot;Â¿CÃ³mo debuggear cÃ³digo Python?&quot;}

# Output:
scores = {
    &quot;hard&quot;: 0.85,      # Alta complejidad tÃ©cnica
    &quot;soft&quot;: 0.15,      # Baja complejidad emocional
    &quot;web_query&quot;: 0.10  # No requiere bÃºsqueda web
}
</code></pre>
<p><strong>Modos de operaciÃ³n:</strong>
- <strong>PRIMARY:</strong> TRMClassifier con torch (arquitectura recursiva, modelo entrenado)
- <strong>FALLBACK:</strong> Rule-based classifier (keywords, sin dependencias externas)</p>
<p><strong>Factory:</strong> <code>create_trm_classifier_callable(config)</code></p>
<p><strong>LOC:</strong> 273 (classifier/trm.py)
<strong>Tests:</strong> test_trm_classifier.py</p>
<hr />
<h3 id="2-mcp-core-mcpcorepy">2. MCP Core (<code>mcp/core.py</code>)<a class="headerlink" href="#2-mcp-core-mcpcorepy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> Calcular weights alpha/beta para routing expert/empathy.</p>
<p><strong>Callable Signature:</strong></p>
<pre><code class="language-python">WeightingCallable = Callable[[Dict[str, Any]], Dict[str, float]]

# Input:
state = {
    &quot;input&quot;: &quot;texto original&quot;,
    &quot;hard&quot;: 0.85,
    &quot;soft&quot;: 0.15
}

# Output:
weights = {
    &quot;alpha&quot;: 0.82,  # Weight para expert
    &quot;beta&quot;: 0.18    # Weight para empathy
}
</code></pre>
<p><strong>Modos de operaciÃ³n:</strong>
- <strong>Rules-based:</strong> HeurÃ­sticas basadas en hard/soft scores
- <strong>Learned:</strong> Neural network entrenada (requiere torch)
- <strong>Cache:</strong> Vector Quantization para queries similares</p>
<p><strong>Factory:</strong> <code>create_mcp_weighter_callable(config)</code></p>
<p><strong>LOC:</strong> 500 (mcp/core.py)
<strong>Tests:</strong> test_mcp.py</p>
<hr />
<h3 id="3-emotional-context-engine-emotioncontext_enginepy">3. Emotional Context Engine (<code>emotion/context_engine.py</code>)<a class="headerlink" href="#3-emotional-context-engine-emotioncontext_enginepy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> Detectar emociones (16), culturas (8), y proveer recomendaciones de modulaciÃ³n.</p>
<p><strong>Callable Signature:</strong></p>
<pre><code class="language-python">EmotionDetectorCallable = Callable[[bytes], Optional[Dict[str, Any]]]

# Input:
audio_or_text = &quot;Me siento frustrado con este error&quot;

# Output:
emotion = {
    &quot;emotion&quot;: &quot;FRUSTRATED&quot;,
    &quot;confidence&quot;: 0.85,
    &quot;empathy_level&quot;: 0.9,
    &quot;cultural_context&quot;: &quot;spain&quot;,
    &quot;voice_modulation&quot;: {
        &quot;speed&quot;: 0.9,
        &quot;pitch&quot;: 1.0,
        &quot;emotion_intensity&quot;: 0.9
    }
}
</code></pre>
<p><strong>CaracterÃ­sticas:</strong>
- 16 emociones: neutral, excited, frustrated, urgent, confused, etc.
- 8 culturas: Spain, Mexico, Argentina, Colombia, USA, UK, France, Germany
- User profiling (Ãºltimas 20 interacciones)
- Voice modulation recommendations</p>
<p><strong>Factory:</strong> <code>create_emotion_detector_callable(config)</code></p>
<p><strong>LOC:</strong> 700 (emotion/context_engine.py)
<strong>Tests:</strong> test_emotional_context.py</p>
<hr />
<h3 id="4-cascade-router-cascadeconfidence_routerpy">4. Cascade Router (<code>cascade/confidence_router.py</code>)<a class="headerlink" href="#4-cascade-router-cascadeconfidence_routerpy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> Routing inteligente basado en confianza y especializaciÃ³n.</p>
<p><strong>Callable Signature:</strong></p>
<pre><code class="language-python">RouterCallable = Callable[[Dict[str, Any]], str]

# Input:
state = {
    &quot;input&quot;: &quot;Â¿CuÃ¡l es el clima en Madrid?&quot;,
    &quot;alpha&quot;: 0.3,
    &quot;beta&quot;: 0.2,
    &quot;web_query&quot;: 0.9
}

# Output:
agent_key = &quot;rag&quot;  # One of: rag, expert, empathy, balanced, vision, code, omni, audio
</code></pre>
<p><strong>Decision Tree (7 priorities):</strong>
1. <strong>Vision:</strong> imagen/OCR/grÃ¡ficos â†’ "vision"
2. <strong>Code:</strong> programming skill â†’ "code"
3. <strong>RAG:</strong> web_query â‰¥ 0.7 â†’ "rag"
4. <strong>Omni-Loop:</strong> imagen + texto &gt;20 chars â†’ "omni"
5. <strong>Audio:</strong> input_type == "audio" â†’ "audio"
6. <strong>Expert:</strong> alpha â‰¥ 0.7 â†’ "expert"
7. <strong>Empathy:</strong> beta â‰¥ 0.7 â†’ "empathy"
8. <strong>Balanced:</strong> fallback default â†’ "balanced"</p>
<p><strong>Factory:</strong> <code>create_router_callable(config)</code></p>
<p><strong>LOC:</strong> 541 (cascade/confidence_router.py)
<strong>Tests:</strong> test_cascade.py</p>
<hr />
<h3 id="5-model-pool-modelpoolpy">5. Model Pool (<code>model/pool.py</code>)<a class="headerlink" href="#5-model-pool-modelpoolpy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> GestiÃ³n inteligente de modelos con cache, quantization, y fallback.</p>
<p><strong>CaracterÃ­sticas:</strong>
- <strong>LRU/TTL Cache:</strong> hot (5min), warm (45s), cold (15s)
- <strong>Dynamic Quantization:</strong> IQ3_XXS (450MB), Q4_K_M (700MB), Q5_K_M (850MB)
- <strong>Context JIT:</strong> Adaptive n_ctx basado en prompt length
- <strong>Fallback Chain:</strong> expert_long â†’ expert_short â†’ tiny
- <strong>Working-set Detection:</strong> â‰¥3 accesos en 5min = hot</p>
<p><strong>API Principal:</strong></p>
<pre><code class="language-python">pool = ModelPool()

# Get model con auto-context
model = pool.get_for_prompt(&quot;expert_short&quot;, &quot;What is Python?&quot;)
# â†’ Loads with n_ctx=512 (short prompt)

# Auto-quantization
params = pool.get_model_params(&quot;Write a 2000 word essay...&quot;)
# â†’ {'quantization': 'Q5_K_M', 'n_ctx': 4096}
</code></pre>
<p><strong>LOC:</strong> 831 (model/pool.py)
<strong>Tests:</strong> test_model_pool.py</p>
<hr />
<h3 id="6-rag-agent-agentsragpy">6. RAG Agent (<code>agents/rag.py</code>)<a class="headerlink" href="#6-rag-agent-agentsragpy" title="Permanent link">&para;</a></h3>
<p><strong>Responsabilidad:</strong> Pipeline completa de bÃºsqueda web + sÃ­ntesis.</p>
<p><strong>Pipeline (6 pasos):</strong>
1. <strong>SAFE MODE CHECK:</strong> Verificar Safe Mode
2. <strong>BÃšSQUEDA CACHEADA:</strong> SearXNG + WebCache (TTL dinÃ¡mico)
3. <strong>AUDITORÃA PRE:</strong> log_web_query() con SHA-256
4. <strong>SÃNTESIS PROMPT:</strong> Prompt engineering con snippets
5. <strong>LLM GENERATION:</strong> Expert model (short/long segÃºn contexto)
6. <strong>AUDITORÃA POST:</strong> log_web_query() con response + HMAC</p>
<p><strong>API Principal:</strong></p>
<pre><code class="language-python">from sarai_agi.agents.rag import execute_rag

state = {
    &quot;input&quot;: &quot;Â¿CÃ³mo estÃ¡ el clima en Tokio?&quot;,
    &quot;scores&quot;: {&quot;web_query&quot;: 0.9}
}

result_state = execute_rag(state, model_pool)
# â†’ state updated with 'response' and 'rag_metadata'
</code></pre>
<p><strong>LOC:</strong> 337 (agents/rag.py)
<strong>Tests:</strong> test_rag_system.py (22 tests)</p>
<hr />
<h2 id="flujo-de-ejecucion-detallado">ğŸ”„ Flujo de EjecuciÃ³n Detallado<a class="headerlink" href="#flujo-de-ejecucion-detallado" title="Permanent link">&para;</a></h2>
<h3 id="ejemplo-1-query-tecnica">Ejemplo 1: Query TÃ©cnica<a class="headerlink" href="#ejemplo-1-query-tecnica" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">Input: &quot;Â¿CÃ³mo implementar quicksort en Python?&quot;

1. TRM Classifier:
   scores = {
       &quot;hard&quot;: 0.88,
       &quot;soft&quot;: 0.12,
       &quot;web_query&quot;: 0.05
   }

2. MCP Weighter:
   weights = {
       &quot;alpha&quot;: 0.85,  # Alta confianza en expert
       &quot;beta&quot;: 0.15
   }

3. Emotion Detector:
   emotion = {
       &quot;emotion&quot;: &quot;NEUTRAL&quot;,
       &quot;confidence&quot;: 0.75,
       &quot;empathy_level&quot;: 0.3
   }

4. Router:
   agent_key = &quot;expert&quot;  # alpha â‰¥ 0.7

5. Response Generator (Expert):
   - Model Pool selecciona: expert_short
   - Cascade Router analiza confidence
   - Tier 1 (LFM2): confidence=0.7 â†’ responde directamente
   - Latency: ~1.2s

Output: Respuesta tÃ©cnica con cÃ³digo quicksort
</code></pre>
<h3 id="ejemplo-2-query-emocional">Ejemplo 2: Query Emocional<a class="headerlink" href="#ejemplo-2-query-emocional" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">Input: &quot;Me siento triste y necesito apoyo&quot;

1. TRM Classifier:
   scores = {
       &quot;hard&quot;: 0.10,
       &quot;soft&quot;: 0.85,
       &quot;web_query&quot;: 0.05
   }

2. MCP Weighter:
   weights = {
       &quot;alpha&quot;: 0.15,
       &quot;beta&quot;: 0.82  # Alta confianza en empathy
   }

3. Emotion Detector:
   emotion = {
       &quot;emotion&quot;: &quot;FRUSTRATED&quot;,
       &quot;confidence&quot;: 0.88,
       &quot;empathy_level&quot;: 0.95,
       &quot;cultural_context&quot;: &quot;spain&quot;
   }

4. Router:
   agent_key = &quot;empathy&quot;  # beta â‰¥ 0.7

5. Response Generator (Empathy):
   - Model Pool selecciona: tiny (LFM2 modo empatÃ­a)
   - Response adaptada con empathy_level=0.95
   - Latency: ~1.5s

Output: Respuesta empÃ¡tica y de apoyo emocional
</code></pre>
<h3 id="ejemplo-3-query-web">Ejemplo 3: Query Web<a class="headerlink" href="#ejemplo-3-query-web" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">Input: &quot;Â¿CuÃ¡l es el clima actual en Madrid?&quot;

1. TRM Classifier:
   scores = {
       &quot;hard&quot;: 0.15,
       &quot;soft&quot;: 0.10,
       &quot;web_query&quot;: 0.92  # Alta necesidad de bÃºsqueda web
   }

2. MCP Weighter:
   weights = {
       &quot;alpha&quot;: 0.35,
       &quot;beta&quot;: 0.25
   }

3. Router:
   agent_key = &quot;rag&quot;  # web_query â‰¥ 0.7 (Priority 3)

4. RAG Agent:
   a. Safe Mode check: OK
   b. Web search: SearXNG + cache
      - Query: &quot;clima Madrid actual&quot;
      - Results: 5 snippets (cached, TTL=5min)
   c. Audit PRE: SHA-256 logged
   d. Synthesis prompt:
      &quot;&quot;&quot;
      BasÃ¡ndote en los siguientes resultados de bÃºsqueda:
      1. &quot;Madrid: 18Â°C, parcialmente nublado...&quot;
      2. &quot;PronÃ³stico para hoy: mÃ¡xima 20Â°C...&quot;
      ...
      Responde: Â¿CuÃ¡l es el clima actual en Madrid?
      &quot;&quot;&quot;
   e. LLM generation: expert_short
   f. Audit POST: HMAC logged

5. Response:
   &quot;En Madrid, la temperatura actual es de 18Â°C con cielo
    parcialmente nublado. Se espera una mÃ¡xima de 20Â°C.&quot;

Output: Respuesta sintetizada con informaciÃ³n actualizada
</code></pre>
<hr />
<h2 id="integracion-de-componentes">ğŸ§© IntegraciÃ³n de Componentes<a class="headerlink" href="#integracion-de-componentes" title="Permanent link">&para;</a></h2>
<h3 id="factory-pattern">Factory Pattern<a class="headerlink" href="#factory-pattern" title="Permanent link">&para;</a></h3>
<p>Todos los componentes se integran mediante <strong>factory functions</strong> que devuelven callables compatibles con <code>PipelineDependencies</code>:</p>
<pre><code class="language-python">from sarai_agi.core import create_integrated_pipeline

# Create fully integrated pipeline
pipeline = create_integrated_pipeline(config={
    &quot;enable_parallelization&quot;: True,
    &quot;min_input_length&quot;: 20,
})

# Execute
result = await pipeline.run({&quot;input&quot;: &quot;Your query here&quot;})

# Cleanup
await pipeline.shutdown()
</code></pre>
<h3 id="dependency-injection">Dependency Injection<a class="headerlink" href="#dependency-injection" title="Permanent link">&para;</a></h3>
<p>La pipeline usa <strong>dependency injection</strong> explÃ­cita:</p>
<pre><code class="language-python">@dataclass
class PipelineDependencies:
    trm_classifier: ClassifierCallable          # TRM Classifier
    mcp_weighter: WeightingCallable             # MCP Core
    response_generator: ResponseGeneratorCallable  # Model Pool + Agents
    emotion_detector: Optional[EmotionDetectorCallable] = None
    prefetch_model: Optional[PrefetchCallable] = None
    router: Optional[RouterCallable] = None
</code></pre>
<p>Cada factory crea el callable correspondiente:</p>
<pre><code class="language-python">dependencies = PipelineDependencies(
    trm_classifier=create_trm_classifier_callable(),
    mcp_weighter=create_mcp_weighter_callable(),
    response_generator=create_response_generator_callable(),
    emotion_detector=create_emotion_detector_callable(),
    prefetch_model=create_prefetch_callable(),
    router=create_router_callable(),
)
</code></pre>
<h3 id="graceful-degradation">Graceful Degradation<a class="headerlink" href="#graceful-degradation" title="Permanent link">&para;</a></h3>
<p>Todos los componentes tienen <strong>fallbacks</strong> para degradaciÃ³n graceful:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Primary</th>
<th>Fallback</th>
</tr>
</thead>
<tbody>
<tr>
<td>TRM Classifier</td>
<td>TRMClassifier (torch)</td>
<td>Rule-based (keywords)</td>
</tr>
<tr>
<td>MCP Weighter</td>
<td>MCPCore (rules/learned)</td>
<td>Direct mapping (alpha=hard)</td>
</tr>
<tr>
<td>Emotion Detector</td>
<td>EmotionalContextEngine</td>
<td>None (optional component)</td>
</tr>
<tr>
<td>Router</td>
<td>ConfidenceRouter</td>
<td>Default balanced</td>
</tr>
<tr>
<td>Model Pool</td>
<td>Full cache + quantization</td>
<td>Simple model loading</td>
</tr>
<tr>
<td>RAG Agent</td>
<td>Full pipeline</td>
<td>Sentinel response</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="metricas-del-pipeline">ğŸ“Š MÃ©tricas del Pipeline<a class="headerlink" href="#metricas-del-pipeline" title="Permanent link">&para;</a></h2>
<h3 id="pipeline-metrics">Pipeline Metrics<a class="headerlink" href="#pipeline-metrics" title="Permanent link">&para;</a></h3>
<p>El pipeline recopila mÃ©tricas detalladas en cada ejecuciÃ³n:</p>
<pre><code class="language-python">result[&quot;metadata&quot;][&quot;pipeline_metrics&quot;] = {
    &quot;classify_ms&quot;: 12.5,      # TRM Classifier latency
    &quot;weights_ms&quot;: 3.2,        # MCP weighter latency
    &quot;emotion_ms&quot;: 8.7,        # Emotion detection latency
    &quot;routing_ms&quot;: 0.8,        # Router latency
    &quot;generation_ms&quot;: 1250.0,  # Response generation latency
    &quot;response_latency_ms&quot;: 1285.3,  # Total latency
    &quot;prefetch_target&quot;: &quot;expert_short&quot;  # Prefetched model
}
</code></pre>
<h3 id="performance-targets-v360">Performance Targets (v3.6.0)<a class="headerlink" href="#performance-targets-v360" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Actual</th>
</tr>
</thead>
<tbody>
<tr>
<td>Classification latency</td>
<td>&lt;50ms</td>
<td>~12ms</td>
</tr>
<tr>
<td>Weighting latency</td>
<td>&lt;20ms</td>
<td>~3ms</td>
</tr>
<tr>
<td>Emotion detection</td>
<td>&lt;50ms</td>
<td>~9ms</td>
</tr>
<tr>
<td>Routing latency</td>
<td>&lt;5ms</td>
<td>~1ms</td>
</tr>
<tr>
<td>Total overhead</td>
<td>&lt;150ms</td>
<td>~30ms</td>
</tr>
<tr>
<td>Response latency P50</td>
<td>&lt;3s</td>
<td>~1.3s (LFM2), ~25s (RAG)</td>
</tr>
<tr>
<td>Response latency P99</td>
<td>&lt;30s</td>
<td>~18s (Qwen-3)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="testing-de-integracion">ğŸ§ª Testing de IntegraciÃ³n<a class="headerlink" href="#testing-de-integracion" title="Permanent link">&para;</a></h2>
<h3 id="test-suite-completo">Test Suite Completo<a class="headerlink" href="#test-suite-completo" title="Permanent link">&para;</a></h3>
<p><strong>Archivo:</strong> <code>tests/test_integration_e2e.py</code></p>
<p><strong>Cobertura:</strong>
- âœ… Pipeline creation
- âœ… Technical query routing (expert)
- âœ… Emotional query routing (empathy)
- âœ… Web query routing (RAG)
- âœ… Emotion detection
- âœ… Metrics collection
- âœ… Parallel/sequential execution
- âœ… Scores propagation
- âœ… Multiple sequential queries
- âœ… Error handling
- âœ… State immutability
- âœ… Component integration
- âœ… Performance tests</p>
<p><strong>EjecuciÃ³n:</strong></p>
<pre><code class="language-bash"># Suite completa
pytest tests/test_integration_e2e.py -v

# Con coverage
pytest tests/test_integration_e2e.py --cov=src/sarai_agi/core --cov-report=html

# Clase especÃ­fica
pytest tests/test_integration_e2e.py::TestIntegratedPipeline -v
</code></pre>
<hr />
<h2 id="uso-desde-cli">ğŸš€ Uso desde CLI<a class="headerlink" href="#uso-desde-cli" title="Permanent link">&para;</a></h2>
<h3 id="instalacion">InstalaciÃ³n<a class="headerlink" href="#instalacion" title="Permanent link">&para;</a></h3>
<pre><code class="language-bash"># Clonar repo
git clone https://github.com/iagenerativa/sarai-agi.git
cd sarai-agi

# Setup environment
./scripts/bootstrap_env.sh
source .venv/bin/activate

# Instalar dependencias
pip install -e .
</code></pre>
<h3 id="cli-integrada">CLI Integrada<a class="headerlink" href="#cli-integrada" title="Permanent link">&para;</a></h3>
<pre><code class="language-bash"># Query Ãºnica
python cli.py &quot;Â¿CÃ³mo funciona el aprendizaje por refuerzo?&quot;

# Query con verbose
python cli.py --verbose &quot;Â¿QuÃ© es Python?&quot;

# Modo interactivo
python cli.py --interactive

# Modo interactivo con verbose
python cli.py -i -v
</code></pre>
<p><strong>Output ejemplo:</strong></p>
<pre><code>================================================================================
QUERY: Â¿CÃ³mo funciona el aprendizaje por refuerzo?
================================================================================

ğŸ“ RESPONSE (expert agent):
--------------------------------------------------------------------------------
El aprendizaje por refuerzo es una tÃ©cnica de machine learning donde un agente
aprende a tomar decisiones Ã³ptimas a travÃ©s de prueba y error, recibiendo
recompensas o penalizaciones por sus acciones...
--------------------------------------------------------------------------------

ğŸ” METADATA:
  Agent: expert

  Emotion:
    Detected: NEUTRAL
    Confidence: 0.75
    Empathy Level: 0.30
    Cultural Context: neutral

  Scores:
    Hard: 0.82
    Soft: 0.18
    Web Query: 0.05
    Alpha: 0.80
    Beta: 0.20

  Pipeline Metrics:
    Classify: 12.34ms
    Weights: 3.21ms
    Emotion: 8.76ms
    Routing: 0.87ms
    Generation: 1234.56ms
    Total: 1265.43ms
</code></pre>
<hr />
<h2 id="referencias">ğŸ“š Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<h3 id="documentacion-de-componentes">DocumentaciÃ³n de Componentes<a class="headerlink" href="#documentacion-de-componentes" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>TRM Classifier:</strong> <code>src/sarai_agi/classifier/trm.py</code></li>
<li><strong>MCP Core:</strong> <code>src/sarai_agi/mcp/core.py</code></li>
<li><strong>Emotional Context:</strong> <code>src/sarai_agi/emotion/context_engine.py</code></li>
<li><strong>Cascade Router:</strong> <code>src/sarai_agi/cascade/confidence_router.py</code></li>
<li><strong>Model Pool:</strong> <code>src/sarai_agi/model/pool.py</code></li>
<li><strong>RAG Agent:</strong> <code>src/sarai_agi/agents/rag.py</code></li>
<li><strong>Pipeline:</strong> <code>src/sarai_agi/pipeline/parallel.py</code></li>
</ul>
<h3 id="tests">Tests<a class="headerlink" href="#tests" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Integration E2E:</strong> <code>tests/test_integration_e2e.py</code></li>
<li><strong>TRM Classifier:</strong> <code>tests/test_trm_classifier.py</code></li>
<li><strong>MCP Core:</strong> <code>tests/test_mcp.py</code></li>
<li><strong>Emotion:</strong> <code>tests/test_emotional_context.py</code></li>
<li><strong>Cascade:</strong> <code>tests/test_cascade.py</code></li>
<li><strong>Model Pool:</strong> <code>tests/test_model_pool.py</code></li>
<li><strong>RAG System:</strong> <code>tests/test_rag_system.py</code></li>
</ul>
<h3 id="documentacion-adicional">DocumentaciÃ³n Adicional<a class="headerlink" href="#documentacion-adicional" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Arquitectura General:</strong> <code>docs/ARCHITECTURE_OVERVIEW.md</code></li>
<li><strong>RAG Memory:</strong> <code>docs/RAG_MEMORY.md</code></li>
<li><strong>Estado v3.4:</strong> <code>docs/ESTADO_ACTUAL_v3.4.md</code></li>
<li><strong>Estado v3.5:</strong> <code>docs/ESTADO_ACTUAL_v3.5.md</code></li>
<li><strong>Migration Plan:</strong> <code>docs/MIGRATION_PLAN_v3_5_1.md</code></li>
</ul>
<hr />
<h2 id="roadmap-de-integracion">ğŸ¯ Roadmap de IntegraciÃ³n<a class="headerlink" href="#roadmap-de-integracion" title="Permanent link">&para;</a></h2>
<h3 id="completado-v360">âœ… Completado (v3.6.0)<a class="headerlink" href="#completado-v360" title="Permanent link">&para;</a></h3>
<ul>
<li>[x] TRM Classifier integration</li>
<li>[x] MCP weighting system</li>
<li>[x] Emotional Context Engine</li>
<li>[x] Cascade Router</li>
<li>[x] Model Pool con cache LRU/TTL</li>
<li>[x] RAG Agent completo</li>
<li>[x] Pipeline paralela</li>
<li>[x] Factory functions para todos los componentes</li>
<li>[x] CLI integrada</li>
<li>[x] Tests E2E completos</li>
<li>[x] DocumentaciÃ³n de arquitectura</li>
</ul>
<h3 id="en-progreso-v370">ğŸ”„ En Progreso (v3.7.0)<a class="headerlink" href="#en-progreso-v370" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Fluidity Layer (Layer3 - tone smoothing)</li>
<li>[ ] Vision integration (Qwen3-VL-4B)</li>
<li>[ ] Code integration (VisCoder2-7B)</li>
<li>[ ] Audio integration (Omni-3B + NLLB)</li>
<li>[ ] Omni-Loop refinement</li>
<li>[ ] Skills integration (SQL, Bash, Network)</li>
</ul>
<h3 id="pendiente-v40">ğŸ“‹ Pendiente (v4.0+)<a class="headerlink" href="#pendiente-v40" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Sidecars architecture</li>
<li>[ ] Ethics Guard pre/post filtering</li>
<li>[ ] Meta-learning feedback loop</li>
<li>[ ] Advanced telemetry dashboard</li>
<li>[ ] Multi-user support</li>
<li>[ ] Production deployment guides</li>
</ul>
<hr />
<h2 id="changelog">ğŸ“ Changelog<a class="headerlink" href="#changelog" title="Permanent link">&para;</a></h2>
<h3 id="v360-2025-11-04">v3.6.0 (2025-11-04)<a class="headerlink" href="#v360-2025-11-04" title="Permanent link">&para;</a></h3>
<ul>
<li>âœ¨ <strong>NEW:</strong> Sistema integrado completo</li>
<li>âœ¨ <strong>NEW:</strong> Factory functions para todos los componentes</li>
<li>âœ¨ <strong>NEW:</strong> CLI integrada con modo interactivo</li>
<li>âœ¨ <strong>NEW:</strong> Tests E2E completos (24 tests)</li>
<li>âœ¨ <strong>NEW:</strong> DocumentaciÃ³n de arquitectura integrada</li>
<li>ğŸ› <strong>FIX:</strong> Graceful degradation en todos los componentes</li>
<li>ğŸ› <strong>FIX:</strong> Error handling completo</li>
<li>ğŸ“š <strong>DOCS:</strong> INTEGRATION_ARCHITECTURE.md</li>
<li>ğŸ§ª <strong>TESTS:</strong> test_integration_e2e.py (24 tests, 100% passing)</li>
</ul>
<hr />
<p><strong>Autor:</strong> SARAi Team
<strong>Licencia:</strong> MIT
<strong>Repositorio:</strong> https://github.com/iagenerativa/sarai-agi
<strong>VersiÃ³n:</strong> v3.6.0</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 iagenerativa - <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>